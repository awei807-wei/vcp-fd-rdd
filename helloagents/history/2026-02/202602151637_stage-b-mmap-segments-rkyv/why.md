# 阶段 B：持久化终局（零拷贝架构）

## 背景

当前快照采用 bincode（v2~v5），加载时必须把 body 反序列化为内存结构，随后还需要重建派生索引；在百万级索引下，这会把冷启动拉到“秒级”。

阶段 B 目标是把“冷启动耗时”从“与数据量相关”变为“与数据量几乎无关”：

- 快照文件采用**段式物理布局**（Trigram 段 / Metadata 段 / Path 段 + 其他必要段）
- 启动时通过 **mmap 映射** 直接获得各段的只读视图
- Trigram posting 使用 **Lazy Decode**：仅对查询命中的 posting 做 Roaring 解码
- roots 列表作为协议的一部分固化到快照内，root 不一致直接拒绝加载并走 rebuild（最安全）

## 成功标准

1. 冷启动：建立 mmap + 校验 manifest/段校验后即可开始查询（不做全量反序列化）。
2. 段式可演进：每段独立 checksum + version，支持平滑迁移与兼容读取旧版本。
3. 查询正确：匹配逻辑与现有 L2 一致（trigram 交集 → 精确过滤）。

