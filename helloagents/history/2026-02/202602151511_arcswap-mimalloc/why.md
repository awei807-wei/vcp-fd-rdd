# Step 1：ArcSwap + mimalloc（动态止血）

## 背景

当前 `fd-rdd` 在 overflow / watcher 异常触发兜底重建时，会对在线索引执行原地 `reset()`，导致重建期间查询结果瞬间归零/不可用。这在生产语义上等同于服务不可用（Bug）。

同时，动态更新/重建过程会产生大量短生命周期分配与容量波动，默认分配器下 RSS 回吐不稳定，容易把“分配器碎片与抖动”误当成数据结构问题，从而干扰后续（Step 2）mmap 段式持久化的收益评估。

## 目标（本 Step 的成功标准）

1. **后台静默重建**：重建在后台构建新索引，构建完成后一次性原子切换；重建期间查询始终可用（允许短暂陈旧，但不允许“清空”）。
2. **读路径零侵入**：查询链路只做 `ArcSwap` 的轻量加载，不引入全局大锁，避免长尾抖动。
3. **事件一致性**：重建期间发生的事件不会在切换后丢失（通过 pending 事件回放）。
4. **分配器噪声隔离**：提供可控的 `mimalloc` 全局分配器开关，便于在动态场景下观察 RSS 与回吐特性。

## 非目标（明确延后到 Step 2）

- mmap 段式索引格式（替代 bincode snapshot）
- 路径 interning（lasso/ustr）与存储层协议整体重构

